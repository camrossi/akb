# This is a basic workflow to help you get started with Actions

name: create_intaller_ova

# Controls when the workflow will run
on:
  release:
    types: [published]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:
env:
  GOVC_INSECURE: True
  ANSIBLE_HOST_KEY_CHECKING: False
  DC: STLD
  VM_FOLDER: Templates
  NKT_TEMPLATE: NKT_K8sNode_Template
  DESTINATION_PATH: /nfs-share/www/nkt
# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  build_nkt:
    # The type of runner that the job will run on
    runs-on: self-hosted
    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Create Snapshot for K8s Node Template
        run: | 
          govc snapshot.create -vm=$NKT_TEMPLATE PreBuild
      
      - name: Power On K8s Node Template
        run: | 
          govc vm.power -on $NKT_TEMPLATE
      
      - name: Prepare K8s Node Template
        run: | 
          ansible-playbook -b -i ansible/inventory/sandbox.ini ansible/prepare_sandbox_template.yaml 
      
      - name: Power Off Node Template and wait for OS ShutDown
        run: | 
          govc vm.power -s $NKT_TEMPLATE && govc object.collect -s "/$DC/vm/$VM_FOLDER/$NKT_TEMPLATE" -runtime.powerState poweredOff
      
      - name: Export NKT K8s Node Template
        run: | 
          ovftool vi://$GOVC_URL/$DC/vm/$VM_FOLDER/$NKT_TEMPLATE/$NKT_TEMPLATE/$NKT_TEMPLATE $DESTINATION_PATH/nkt_template.ova   

      - name: Set permission for NKT K8s Node Template
        run: | 
          chmod 777 $DESTINATION_PATH/nkt_template.ova

      - name: Delete K8s Node Template Snapshot
        run: | 
          govc snapshot.remove -vm=$NKT_TEMPLATE PreBuild      
      
      - name: Start Installer Build
        run: | 
          packer build -var "version=${{github.ref_name}}" packer
      
      - name: Export Installer OVA
        run: | 
          ovftool vi://$GOVC_URL/$DC/vm/$VM_FOLDER/$NKT_TEMPLATE/NKT_Installer_Template-${{github.ref_name}} $DESTINATION_PATH/nkt_installer-${{github.ref_name}}.ova
      
      - name: Set permission for Installer OVA
        run: | 
          chmod 777 $DESTINATION_PATH/nkt_installer-${{github.ref_name}}.ova